unit svcArafLogoServis;

interface

uses
    Windows,
    Messages,
    SysUtils,
    Classes,
    Graphics,
    Dialogs,
    Controls,
    SvCom_NTService, Vcl.ExtCtrls,IniFiles, IdCoder, IdCoder3to4, IdCoderMIME,
  IdBaseComponent, Data.DB, Data.Win.ADODB;

type
  TNTService1 = class(TNtService)
    tmr1: TTimer;
    conMain: TADOConnection;
    IdDecoderMIME1: TIdDecoderMIME;
    IdEncoderMIME1: TIdEncoderMIME;
    procedure NtServiceStart(Sender: TNtService; var DoAction: Boolean);
  private
    procedure ReadConnectionIniFile;
    { Private declarations }
  public
    { Public declarations }
  end;

  var
  APP_SERVERNAME: string;
  APP_DBNAME: string;
  APP_USERNAME: string;
  APP_PASSWORD: string;
  APP_PATH : string;
var
  NTService1: TNTService1;

implementation

{$R *.DFM}


procedure TNTService1.NtServiceStart(Sender: TNtService; var DoAction: Boolean);
begin
tmr1.Enabled:=True;
end;
procedure TNTService1.ReadConnectionIniFile;
var
  xConnectionIni: TIniFile;
begin
  xConnectionIni := TIniFile.Create(ExtractFilePath(Application.ExeName)
      + 'Connection.ini');
  if FileExists(ExtractFilePath(Application.ExeName) + 'Connection.Ini') then
  begin
    xConnectionINI := TIniFile.Create(ExtractFilePath(Application.ExeName)
        + 'Connection.Ini');
    APP_SERVERNAME := IdDecoderMIME1.DecodeString
      (xConnectionINI.ReadString(IdEncoderMIME1.EncodeString
          ('ConnectionInformation'), IdEncoderMIME1.EncodeString('srv_nm'),
        ''));
    APP_DBNAME := IdDecoderMIME1.DecodeString
      (xConnectionINI.ReadString(IdEncoderMIME1.EncodeString
          ('ConnectionInformation'), IdEncoderMIME1.EncodeString('DBName'),
        ''));
    APP_USERNAME := IdDecoderMIME1.DecodeString
      (xConnectionINI.ReadString(IdEncoderMIME1.EncodeString
          ('ConnectionInformation'), IdEncoderMIME1.EncodeString('user_name'),
        ''));
    APP_PASSWORD := IdDecoderMIME1.DecodeString
      (xConnectionINI.ReadString(IdEncoderMIME1.EncodeString
          ('ConnectionInformation'), IdEncoderMIME1.EncodeString('psswrd'),
        ''));
    xConnectionINI.Free;
  end;

  if (Trim(APP_SERVERNAME) = '') or (Trim(APP_DBNAME) = '') or
    (Trim(APP_USERNAME) = '') or (Trim(APP_PASSWORD) = '') then
  begin
    xConnectionForm := TFormConnectionSettings.Create(Self);
    xConnectionForm.ShowModal;
    if xConnectionForm.ModalResult <> mrOk then
    begin
      Application.Terminate;
      Exit;
    end;
    xConnectionForm.Free;
    ReadConnectionIniFile;
  end;
end;

end.


 
